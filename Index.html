<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SNS投稿アプリケーション</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .title {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 24px;
    }

    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }

    .upload-area:hover {
      border-color: #3498db;
    }

    .file-input-wrapper {
      margin: 20px 0;
    }

    #fileInput {
      display: none;
    }

    .file-input-label {
      display: inline-block;
      padding: 12px 24px;
      background-color: #3498db;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .file-input-label:hover {
      background-color: #2980b9;
    }

    .preview {
      max-width: 100%;
      max-height: 300px;
      margin: 20px 0;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .error {
      color: #e74c3c;
      margin: 10px 0;
      padding: 10px;
      background-color: #fde8e7;
      border-radius: 4px;
      font-size: 14px;
      white-space: pre-line;
    }

    .hidden {
      display: none !important;
    }

    #uploadButton {
      width: 100%;
      padding: 12px;
      background-color: #2ecc71;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #uploadButton:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    #uploadButton:hover:not(:disabled) {
      background-color: #27ae60;
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    #loadingText {
      font-size: 18px;
      color: #333;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .file-info {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }
    /* クロップ関連の新しいスタイル */
    .crop-container {
      max-width: 100%;
      margin: 20px 0;
      display: none;
    }

    .crop-area {
      max-width: 100%;
      height: 400px;
      background: #f0f0f0;
      margin-bottom: 10px;
    }

    .crop-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .aspect-ratio-btn {
      padding: 8px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      min-width: 100px;
    }

    .aspect-ratio-btn.active {
      background: #2980b9;
    }

    .crop-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    #cropImage {
      width: 100%;
      max-width: 100%;
      display: block;
    }

  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- ヘッダー -->
    <header class="bg-white shadow-sm mb-8">
      <div class="container mx-auto px-4 py-4">
        <h1 class="text-2xl font-bold text-gray-800 text-center">SNS投稿アプリケーション</h1>
      </div>
    </header>

    <!-- メインコンテンツ -->
    <main>
      <!-- 投稿フォーム -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <form id="postForm" class="space-y-4">
          <div>
            <label for="postText" class="block text-sm font-medium text-gray-700 mb-2">投稿内容</label>
            <textarea
              id="postText"
              name="postText"
              rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="投稿内容を入力してください（最大280文字）"
              maxlength="280"
            ></textarea>
            <div class="flex justify-between items-center mt-1">
              <span id="charCount" class="text-sm text-gray-500">0/280</span>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">投稿先</label>
            <div class="flex flex-wrap gap-4">
              <label class="inline-flex items-center">
                <input type="checkbox" name="platform" value="x" class="form-checkbox h-5 w-5 text-blue-600">
                <span class="ml-2 text-gray-700">X</span>
              </label>
              <label class="inline-flex items-center">
                <input type="checkbox" name="platform" value="threads" class="form-checkbox h-5 w-5 text-blue-600">
                <span class="ml-2 text-gray-700">Threads</span>
              </label>
              <label class="inline-flex items-center">
                <input type="checkbox" name="platform" value="instagram" class="form-checkbox h-5 w-5 text-blue-600">
                <span class="ml-2 text-gray-700">Instagram</span>
              </label>
            </div>
          </div>

          <!-- ファイルアップロード -->
          <div class="space-y-4">
            <label class="block text-sm font-medium text-gray-700">メディアファイル</label>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
              <div class="space-y-2">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                  <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="text-sm text-gray-600">
                  <label for="fileInput" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                    <span>ファイルを選択</span>
                    <input id="fileInput" name="fileInput" type="file" class="sr-only" accept=".jpg,.jpeg,.png,.mov,.mp4">
                  </label>
                  <p class="pl-1">またはドラッグ＆ドロップ</p>
                </div>
                <p class="text-xs text-gray-500">
                  対応形式: JPG, PNG, MOV, MP4<br>
                  サイズ制限: 画像 8MB以内, 動画 30MB以内
                </p>
              </div>
            </div>

            <!-- プレビュー -->
            <div id="previewContainer" class="hidden">
              <div class="flex flex-wrap gap-4">
                <div id="imagePreview" class="hidden">
                  <img src="" alt="プレビュー" class="max-w-full h-auto rounded-lg shadow-sm">
                </div>
                <div id="videoPreview" class="hidden">
                  <video controls class="max-w-full h-auto rounded-lg shadow-sm">
                    お使いのブラウザは動画の再生に対応していません。
                  </video>
                </div>
              </div>
            </div>

            <!-- エラーメッセージ -->
            <div id="errorMessage" class="hidden text-sm text-red-600 bg-red-50 p-3 rounded-md"></div>
          </div>

          <div>
            <button
              type="submit"
              class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
            >
              投稿する
            </button>
          </div>
        </form>
      </div>
    </main>
  </div>

  <!-- ローディングオーバーレイ -->
  <div id="loading" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-50 hidden">
    <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    <p id="loadingText" class="mt-4 text-gray-700">処理中...</p>
  </div>

  <script>
    // 文字数カウント
    document.getElementById('postText').addEventListener('input', function() {
      const charCount = this.value.length;
      document.getElementById('charCount').textContent = `${charCount}/280`;
    });

    // ファイルアップロード処理
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const videoPreview = document.getElementById('videoPreview');
    const errorMessage = document.getElementById('errorMessage');

    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      // ファイルサイズチェック
      const maxSize = file.type.startsWith('video/') ? 30 * 1024 * 1024 : 8 * 1024 * 1024;
      if (file.size > maxSize) {
        showError(`ファイルサイズが大きすぎます。${file.type.startsWith('video/') ? '30MB' : '8MB'}以内のファイルを選択してください。`);
        return;
      }

      // プレビュー表示
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreview.querySelector('img').src = e.target.result;
          imagePreview.classList.remove('hidden');
          videoPreview.classList.add('hidden');
          previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else if (file.type.startsWith('video/')) {
        const video = videoPreview.querySelector('video');
        video.src = URL.createObjectURL(file);
        videoPreview.classList.remove('hidden');
        imagePreview.classList.add('hidden');
        previewContainer.classList.remove('hidden');
      } else {
        showError('対応していないファイル形式です。');
      }
    });

    // ドラッグ＆ドロップ
    const dropZone = document.querySelector('.border-dashed');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
      dropZone.classList.add('border-blue-500');
    }

    function unhighlight(e) {
      dropZone.classList.remove('border-blue-500');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const file = dt.files[0];
      fileInput.files = dt.files;
      const event = new Event('change');
      fileInput.dispatchEvent(event);
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
      setTimeout(() => {
        errorMessage.classList.add('hidden');
      }, 5000);
    }

    function showLoading(message = '処理中...') {
      document.getElementById('loadingText').textContent = message;
      document.getElementById('loading').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    // フォーム送信
    document.getElementById('postForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const postText = document.getElementById('postText').value;
      const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platform"]:checked'))
        .map(checkbox => checkbox.value);

      if (!postText && !fileInput.files[0]) {
        showError('投稿内容またはファイルを入力してください');
        return;
      }

      if (selectedPlatforms.length === 0) {
        showError('投稿先を選択してください');
        return;
      }

      showLoading('投稿中...');

      // ここに投稿処理を実装
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            // 投稿成功時の処理
            document.getElementById('postText').value = '';
            fileInput.value = '';
            previewContainer.classList.add('hidden');
            showError('投稿が完了しました');
          } else {
            showError(result.error || '投稿に失敗しました');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('投稿に失敗しました: ' + error.toString());
        })
        .submitPost({
          text: postText,
          platforms: selectedPlatforms,
          file: fileInput.files[0]
        });
    });
  </script>
</body>
</html>