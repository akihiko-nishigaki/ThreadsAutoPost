<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SNS投稿アプリ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .title {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 24px;
    }

    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }

    .upload-area:hover {
      border-color: #3498db;
    }

    .file-input-wrapper {
      margin: 20px 0;
    }

    #fileInput {
      display: none;
    }

    .file-input-label {
      display: inline-block;
      padding: 12px 24px;
      background-color: #3498db;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .file-input-label:hover {
      background-color: #2980b9;
    }

    .preview {
      max-width: 100%;
      max-height: 300px;
      margin: 20px 0;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .error {
      color: #e74c3c;
      margin: 10px 0;
      padding: 10px;
      background-color: #fde8e7;
      border-radius: 4px;
      font-size: 14px;
      white-space: pre-line;
    }

    .hidden {
      display: none !important;
    }

    #uploadButton {
      width: 100%;
      padding: 12px;
      background-color: #2ecc71;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #uploadButton:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    #uploadButton:hover:not(:disabled) {
      background-color: #27ae60;
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    #loadingText {
      font-size: 18px;
      color: #333;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .file-info {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }
    /* クロップ関連の新しいスタイル */
    .crop-container {
      max-width: 100%;
      margin: 20px 0;
      display: none;
    }

    .crop-area {
      max-width: 100%;
      height: 400px;
      background: #f0f0f0;
      margin-bottom: 10px;
    }

    .crop-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .aspect-ratio-btn {
      padding: 8px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      min-width: 100px;
    }

    .aspect-ratio-btn.active {
      background: #2980b9;
    }

    .crop-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    #cropImage {
      width: 100%;
      max-width: 100%;
      display: block;
    }

  </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto px-4 py-8">
    <!-- ヘッダー -->
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800">SNS投稿アプリ</h1>
    </header>

    <!-- 投稿フォーム -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <form id="postForm" class="space-y-6">
        <!-- テキストエリア -->
        <div>
          <label for="postText" class="block text-sm font-medium text-gray-700 mb-2">投稿内容</label>
          <textarea
            id="postText"
            name="postText"
            rows="4"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="投稿内容を入力してください"
            maxlength="280"
          ></textarea>
          <div class="flex justify-end mt-1">
            <span id="charCount" class="text-sm text-gray-500">0/280</span>
          </div>
        </div>

        <!-- ファイルアップロード -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">メディアファイル</label>
          <div
            id="dropZone"
            class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 transition-colors"
          >
            <input
              type="file"
              id="fileInput"
              class="hidden"
              accept="image/*,video/*"
              multiple
            >
            <div class="space-y-2">
              <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <p class="text-sm text-gray-600">
                ファイルをドラッグ＆ドロップするか、
                <span class="text-indigo-600 hover:text-indigo-500 cursor-pointer" onclick="document.getElementById('fileInput').click()">
                  クリックして選択
                </span>
              </p>
              <p class="text-xs text-gray-500">
                対応ファイル: JPG, PNG, MOV, MP4<br>
                画像: 8MB以内, 動画: 30MB以内
              </p>
            </div>
          </div>
          <!-- プレビューエリア -->
          <div id="previewContainer" class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 hidden"></div>
        </div>

        <!-- プラットフォーム選択 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">投稿先</label>
          <div class="flex space-x-4">
            <label class="inline-flex items-center">
              <input type="checkbox" name="platforms" value="x" class="form-checkbox h-5 w-5 text-indigo-600">
              <span class="ml-2 text-gray-700">X</span>
            </label>
            <label class="inline-flex items-center">
              <input type="checkbox" name="platforms" value="threads" class="form-checkbox h-5 w-5 text-indigo-600">
              <span class="ml-2 text-gray-700">Threads</span>
            </label>
            <label class="inline-flex items-center">
              <input type="checkbox" name="platforms" value="instagram" class="form-checkbox h-5 w-5 text-indigo-600">
              <span class="ml-2 text-gray-700">Instagram</span>
            </label>
          </div>
        </div>

        <!-- エラーメッセージ -->
        <div id="errorMessage" class="hidden text-red-600 text-sm"></div>

        <!-- 送信ボタン -->
        <div class="flex justify-end">
          <button
            type="submit"
            class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            投稿する
          </button>
        </div>
      </form>
    </div>

    <!-- ローディング表示 -->
    <div id="loading" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white p-4 rounded-lg shadow-lg">
        <div class="flex items-center space-x-2">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
          <span class="text-gray-700">処理中...</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 文字数カウント
    const postText = document.getElementById('postText');
    const charCount = document.getElementById('charCount');
    
    postText.addEventListener('input', () => {
      const count = postText.value.length;
      charCount.textContent = `${count}/280`;
    });

    // ファイルアップロード処理
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const files = [];

    // ドラッグ＆ドロップイベント
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      dropZone.classList.add('border-indigo-500');
    }

    function unhighlight() {
      dropZone.classList.remove('border-indigo-500');
    }

    dropZone.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', handleFiles, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const droppedFiles = dt.files;
      handleFiles({ target: { files: droppedFiles } });
    }

    function handleFiles(e) {
      const uploadedFiles = Array.from(e.target.files);
      
      // ファイルサイズと形式のチェック
      for (const file of uploadedFiles) {
        const isImage = file.type.startsWith('image/');
        const isVideo = file.type.startsWith('video/');
        
        if (!isImage && !isVideo) {
          showError('対応していないファイル形式です');
          return;
        }

        const maxSize = isImage ? 8 * 1024 * 1024 : 30 * 1024 * 1024;
        if (file.size > maxSize) {
          showError(`${isImage ? '画像' : '動画'}ファイルは${isImage ? '8MB' : '30MB'}以内にしてください`);
          return;
        }

        files.push(file);
      }

      // プレビュー表示
      showPreviews();
    }

    function showPreviews() {
      previewContainer.innerHTML = '';
      previewContainer.classList.remove('hidden');

      files.forEach((file, index) => {
        const preview = document.createElement('div');
        preview.className = 'relative group';
        
        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          img.className = 'w-full h-32 object-cover rounded';
          preview.appendChild(img);
        } else {
          const video = document.createElement('video');
          video.src = URL.createObjectURL(file);
          video.className = 'w-full h-32 object-cover rounded';
          video.controls = true;
          preview.appendChild(video);
        }

        // 削除ボタン
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity';
        deleteBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
        deleteBtn.onclick = () => {
          files.splice(index, 1);
          showPreviews();
        };
        preview.appendChild(deleteBtn);

        previewContainer.appendChild(preview);
      });
    }

    // エラーメッセージ表示
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => {
        errorDiv.classList.add('hidden');
      }, 5000);
    }

    // ローディング表示
    function showLoading(message = '処理中...') {
      const loadingDiv = document.getElementById('loading');
      loadingDiv.querySelector('span').textContent = message;
      loadingDiv.classList.remove('hidden');
    }

    // ローディング非表示
    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    // フォーム送信処理
    document.getElementById('postForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // 入力値の取得
      const text = postText.value;
      const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(cb => cb.value);

      if (!text && files.length === 0) {
        showError('投稿内容またはファイルを入力してください');
        return;
      }

      if (platforms.length === 0) {
        showError('投稿先を選択してください');
        return;
      }

      showLoading('投稿中...');

      try {
        // ファイルのアップロード
        const uploadedFiles = [];
        for (const file of files) {
          const reader = new FileReader();
          const base64Data = await new Promise((resolve) => {
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(file);
          });

          uploadedFiles.push({
            base64Data,
            fileName: file.name,
            mimeType: file.type
          });
        }

        // 投稿データの作成
        const postData = {
          text,
          files: uploadedFiles,
          platforms: {
            x: platforms.includes('x'),
            threads: platforms.includes('threads'),
            instagram: platforms.includes('instagram')
          }
        };

        // 投稿処理の実行
        const response = await google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)
          .submitPost(postData);

      } catch (error) {
        handleError(error);
      }
    });

    // 成功時の処理
    function handleSuccess(response) {
      hideLoading();
      
      if (response.success) {
        // フォームのリセット
        postText.value = '';
        files.length = 0;
        showPreviews();
        document.querySelectorAll('input[name="platforms"]').forEach(cb => cb.checked = false);
        
        // 成功メッセージ
        alert('投稿が完了しました');
      } else {
        showError(response.error);
      }
    }

    // エラー時の処理
    function handleError(error) {
      hideLoading();
      showError(error.message || '投稿に失敗しました');
    }
  </script>
</body>
</html>